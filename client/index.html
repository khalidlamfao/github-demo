<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Task Manager</title>

    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      if (!window.Babel) {
        const script = document.createElement('script');
        script.src = 'babel.min.js';
        document.head.appendChild(script);
      }
    </script>

    <!-- Axios and Socket.IO -->

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <div id="root"></div>
    </div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      function App() {
        const [token, setToken] = useState(null);
        const [tasks, setTasks] = useState([]);
        const [title, setTitle] = useState('');
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [creatingAccount, setCreatingAccount] = useState(false);

        useEffect(() => {
          if (token) {
            fetchTasks();
            const socket = io({ auth: { token } });
            socket.on('task_created', t => setTasks(prev => [...prev, t]));
            socket.on('task_updated', t => setTasks(prev => prev.map(p => p.id === t.id ? t : p)));
            socket.on('task_deleted', ({ id }) => setTasks(prev => prev.filter(p => p.id !== id)));
            return () => socket.disconnect(); // âœ… fixed typo here
          }
        }, [token]);

        const fetchTasks = async () => {
          const res = await axios.get('/api/tasks', {
            headers: { Authorization: 'Bearer ' + token }
          });
          setTasks(res.data);
        };

        const login = async () => {
          try {
            const res = await axios.post('/api/login', { username, password });
            setToken(res.data.token);
          } catch {
            alert('Login failed');
          }
        };

        const register = async () => {
          try {
            await axios.post('/api/register', { username, password });
            alert('Account created. Please log in.');
            setPassword('');
            setCreatingAccount(false);
          } catch {
            alert('Registration failed');
          }
        };

        const addTask = async () => {
          await axios.post('/api/tasks', { title }, {
            headers: { Authorization: 'Bearer ' + token }
          });
          setTitle('');
        };

        const toggleTask = async (task) => {
          await axios.put('/api/tasks/' + task.id, {
            title: task.title,
            completed: !task.completed
          }, {
            headers: { Authorization: 'Bearer ' + token }
          });
        };

        const deleteTask = async (task) => {
          await axios.delete('/api/tasks/' + task.id, {
            headers: { Authorization: 'Bearer ' + token }
          });
        };

        if (!token) {
          if (creatingAccount) {
            return (
              <div>
                <h2>Create Account</h2>
                <input placeholder="Username" value={username} onChange={e => setUsername(e.target.value)} />
                <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} />
                <button onClick={register}>Register</button>
                <button onClick={() => setCreatingAccount(false)}>Back</button>
              </div>
            );
          }

          return (
            <div>
              <h2>Login</h2>
              <input
                placeholder="Username"
                value={username}
                onChange={e => setUsername(e.target.value)}
              />
              <input
                type="password"
                placeholder="Password"
                value={password}
                onChange={e => setPassword(e.target.value)}
              />
              <button onClick={login}>Login</button>
              <button onClick={() => setCreatingAccount(true)}>Create Account</button>
            </div>
          );
        }

        return (
          <div>
            <h2>Tasks</h2>
            <input
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="New task"
            />
            <button onClick={addTask}>Add</button>
            <ul>
              {tasks.map(task => (
                <li key={task.id}>
                  <input
                    type="checkbox"
                    checked={task.completed}
                    onChange={() => toggleTask(task)}
                  />
                  {task.title}
                  <button onClick={() => deleteTask(task)}>x</button>
                </li>
              ))}
            </ul>
          </div>
        );
      }

      try {
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
      } catch (err) {
        console.error('JSX render error:', err);
      }
    </script>
  </body>
</html>

